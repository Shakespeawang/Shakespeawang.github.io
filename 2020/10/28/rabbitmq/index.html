<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="消息队列作用：解耦、异步、削峰 存在问题：系统变复杂，如果消息队列崩溃就会不可用；一致性问题，多个系统需要数据同步，有的系统可能没有写入成功 ①解耦：加入A系统需要发送数据到B、C、D三个系统，这时候，又来了E系统或者D系统断开，这时就要修改A系统的代码，很麻烦：  解决：用消息队列，A系统把数据发到消息队列中，让其他需要的去接收并消费即可，如果不需要的话，直接断开与消息队列的连接即可，这是一种解">
<meta property="og:type" content="article">
<meta property="og:title" content="shakespeaWang&#39;s Blog">
<meta property="og:url" content="https://shakespeawang.github.io/2020/10/28/rabbitmq/index.html">
<meta property="og:site_name" content="shakespeaWang&#39;s Blog">
<meta property="og:description" content="消息队列作用：解耦、异步、削峰 存在问题：系统变复杂，如果消息队列崩溃就会不可用；一致性问题，多个系统需要数据同步，有的系统可能没有写入成功 ①解耦：加入A系统需要发送数据到B、C、D三个系统，这时候，又来了E系统或者D系统断开，这时就要修改A系统的代码，很麻烦：  解决：用消息队列，A系统把数据发到消息队列中，让其他需要的去接收并消费即可，如果不需要的话，直接断开与消息队列的连接即可，这是一种解">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="c:/Users/vv/AppData/Roaming/Typora/typora-user-images/1595136777799.png">
<meta property="og:image" content="c:/Users/vv/AppData/Roaming/Typora/typora-user-images/1595136802024.png">
<meta property="og:image" content="c:/Users/vv/AppData/Roaming/Typora/typora-user-images/1595137104802.png">
<meta property="og:image" content="c:/Users/vv/AppData/Roaming/Typora/typora-user-images/1594969339322.png">
<meta property="og:image" content="c:/Users/vv/AppData/Roaming/Typora/typora-user-images/1594969391216.png">
<meta property="og:image" content="c:/Users/vv/AppData/Roaming/Typora/typora-user-images/1594969858869.png">
<meta property="og:image" content="c:/Users/vv/AppData/Roaming/Typora/typora-user-images/1594973561587.png">
<meta property="og:image" content="c:/Users/vv/AppData/Roaming/Typora/typora-user-images/1595074479852.png">
<meta property="og:image" content="c:/Users/vv/AppData/Roaming/Typora/typora-user-images/1595074463221.png">
<meta property="og:image" content="c:/Users/vv/AppData/Roaming/Typora/typora-user-images/1595074434239.png">
<meta property="og:image" content="c:/Users/vv/AppData/Roaming/Typora/typora-user-images/1595074448060.png">
<meta property="article:published_time" content="2020-10-28T01:57:39.504Z">
<meta property="article:modified_time" content="2020-07-19T05:43:13.788Z">
<meta property="article:author" content="Shakespeawang">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="c:/Users/vv/AppData/Roaming/Typora/typora-user-images/1595136777799.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>shakespeaWang&#39;s Blog</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

    
<link rel="stylesheet" href="/lib/meslo-LG/styles.css">

    
<link rel="stylesheet" href="/lib/justified-gallery/justifiedGallery.min.css">

    
<link rel="stylesheet" href="/css/style.css">

    <!-- rss -->
    
    
    <!-- jquery -->
    
<script src="/lib/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 5.2.0"></head>

<body>
    <div class="banner">
<div id="blogtitel" class="blogtitel">shakespeaWang&#39;s Blog</div>
<ul id="wrapper" class="wrapper">
  <div class="sun">
    <div class="star"></div>
  </div>
  <div class="mercury">
    <div class="planet">
      <div class="shadow"></div>
    </div>
  </div>
  <div class="venus">
    <div class="planet">
      <div class="shadow"></div>
    </div>
  </div>
  <div class="earth">
    <div class="planet"><div class="shadow"></div></div>
  </div>
  <div class="mars">
    <div class="planet"><div class="shadow"></div></div>
  </div>
  <div class="jupiter">
    <div class="planet"><div class="shadow"></div></div>
  </div>
</ul>
</div>

    <div class="background">
      
        <div id="header-post">
  <a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/home/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a target="_blank" rel="noopener" href="http://github.com/tzvetkov75">Projects</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2020/10/28/ReadWriterLock%E6%8E%A5%E5%8F%A3/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li>
        
        
        <li><a class="icon" href="/2020/10/28/nginx%E3%80%81vue%E7%AD%89%E9%9D%A2%E8%AF%95%E8%80%83%E5%AF%9F%E5%86%99%E6%B3%95/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li>
        <li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://shakespeawang.github.io/2020/10/28/rabbitmq/"><i class="fa fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://shakespeawang.github.io/2020/10/28/rabbitmq/&text="><i class="fa fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://shakespeawang.github.io/2020/10/28/rabbitmq/&title="><i class="fa fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://shakespeawang.github.io/2020/10/28/rabbitmq/&is_video=false&description="><i class="fa fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=&body=Check out this article: https://shakespeawang.github.io/2020/10/28/rabbitmq/"><i class="fa fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://shakespeawang.github.io/2020/10/28/rabbitmq/&title="><i class="fa fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://shakespeawang.github.io/2020/10/28/rabbitmq/&title="><i class="fa fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://shakespeawang.github.io/2020/10/28/rabbitmq/&title="><i class="fa fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://shakespeawang.github.io/2020/10/28/rabbitmq/&title="><i class="fa fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://shakespeawang.github.io/2020/10/28/rabbitmq/&name=&description="><i class="fa fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="toc-number">1.</span> <span class="toc-text">消息队列</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80-%E3%80%81%E7%AE%80%E5%8D%95%E9%98%9F%E5%88%97%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.1.</span> <span class="toc-text">一 、简单队列模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81work-queue-%E5%B7%A5%E4%BD%9C%E9%98%9F%E5%88%97%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.2.</span> <span class="toc-text">二、work queue 工作队列模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E6%B6%88%E6%81%AF%E5%BA%94%E7%AD%94"><span class="toc-number">1.3.</span> <span class="toc-text">三、消息应答</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E8%AE%A2%E9%98%85%E6%A8%A1%E5%BC%8F-publish-subscribe"><span class="toc-number">1.4.</span> <span class="toc-text">四、订阅模式 publish subscribe</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E8%B7%AF%E7%94%B1%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.5.</span> <span class="toc-text">五、路由模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%AD%E3%80%81%E4%B8%BB%E9%A2%98%E6%A8%A1%E5%BC%8F-topic"><span class="toc-number">1.6.</span> <span class="toc-text">六、主题模式 topic</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%83%E3%80%81%E6%B6%88%E6%81%AF%E7%A1%AE%E8%AE%A4%E6%9C%BA%E5%88%B6"><span class="toc-number">1.7.</span> <span class="toc-text">七、消息确认机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF%EF%BC%9A"><span class="toc-number">1.8.</span> <span class="toc-text">应用场景：</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

      
      <div class="content index width mx-auto px2 my4">
          
          <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">shakespeaWang's Blog</span>
      </span>
      
    <div class="postdate">
        <time datetime="2020-10-28T01:57:39.504Z" itemprop="datePublished">2020-10-28</time>
    </div>


      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h2 id="消息队列"><a href="#消息队列" class="headerlink" title="消息队列"></a>消息队列</h2><p><strong>作用</strong>：解耦、异步、削峰</p>
<p><strong>存在问题</strong>：系统变复杂，如果消息队列崩溃就会不可用；一致性问题，多个系统需要数据同步，有的系统可能没有写入成功</p>
<p>①<strong>解耦</strong>：加入A系统需要发送数据到B、C、D三个系统，这时候，又来了E系统或者D系统断开，这时就要修改A系统的代码，很麻烦：</p>
<p><img src="C:\Users\vv\AppData\Roaming\Typora\typora-user-images\1595136777799.png" alt="1595136777799"></p>
<p>解决：用消息队列，A系统把数据发到消息队列中，让其他需要的去接收并消费即可，如果不需要的话，直接断开与消息队列的连接即可，这是一种解耦</p>
<p>②<strong>异步</strong>：在本地系统中写库，也需要同步到其他的库中（读写分离），但是写到其他库中比较耗时，这样返回响应就慢，于是就把写到其他库的操作发给消息队列，其他库去读消息队列，再消费即可；</p>
<p><img src="C:\Users\vv\AppData\Roaming\Typora\typora-user-images\1595136802024.png" alt="1595136802024"></p>
<p>③<strong>削峰</strong>：把峰值期间的请求先放到数据库，然后A系统再按照自己最大的吞吐量去处理请求并返回，这时会有很多请求积压在消息队列，但是高峰期一旦度过，新增的请求会变少，这时把积压的请求处理掉即可</p>
<p><img src="C:\Users\vv\AppData\Roaming\Typora\typora-user-images\1595137104802.png" alt="1595137104802"></p>
<p>用户添加：</p>
<p><img src="C:\Users\vv\AppData\Roaming\Typora\typora-user-images\1594969339322.png" alt="1594969339322"></p>
<p>virtual hosts 添加：类似与数据库的添加</p>
<p>broker 是指<strong>一个或多个 erlang node</strong> 的逻辑分组，且 node 上运行着 RabbitMQ 应用程序。cluster 是在 broker 的基础之上，增加了 node 之间共享元数据的约束</p>
<p>vhost 可以理解为虚拟 broker ，即 mini-RabbitMQ  server。其内部均含有独立的 queue、exchange 和 binding 等，但最最重要的是，其拥有独立的权限系统，可以做到 vhost 范围的用户控制。当然，从 RabbitMQ 的全局角度，vhost 可以作为不同权限隔离的手段（一个典型的例子就是不同的应用可以跑在不同的 vhost 中）。</p>
<p><img src="C:\Users\vv\AppData\Roaming\Typora\typora-user-images\1594969391216.png" alt="1594969391216"></p>
<p>exchange 内部实现为保存 binding 关系的查找表；channel 是实际进行路由工作的实体，即负责按照 routing_key 将 message 投递给 queue 。由 AMQP 协议描述可知，channel 是真实 TCP 连接之上的虚拟连接，所有 AMQP 命令都是通过 channel 发送的，且每一个 channel 有唯一的 ID。<strong>一个 channel 只能被单独一个操作系统线程使用</strong>，故投递到特定 channel 上的 message 是有顺序的。但一个操作系统线程上允许使用多个 channel </p>
<p>基于AMQP协议:RabbitMQ使用信道的方式来传输数据。<strong>信道是建立在真实的TCP连接的虚拟连接</strong>，且每条TCP连接上的信道数量没有限制。</p>
<p>理解：一条tcp连接，在这个连接上有多个信道</p>
<h3 id="一-、简单队列模式"><a href="#一-、简单队列模式" class="headerlink" title="一 、简单队列模式"></a>一 、简单队列模式</h3><p><img src="C:\Users\vv\AppData\Roaming\Typora\typora-user-images\1594969858869.png" alt="1594969858869"></p>
<ul>
<li><p>生产者</p>
</li>
<li><p>消费者</p>
</li>
<li><p>队列</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建连接通道</span></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.ConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeoutException;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConnectionUtils</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Connection <span class="title">getConnection</span><span class="params">()</span> <span class="keyword">throws</span> IOException, TimeoutException </span>&#123;</span><br><span class="line">        ConnectionFactory factory = <span class="keyword">new</span> ConnectionFactory();</span><br><span class="line"></span><br><span class="line">        factory.setHost(<span class="string">&quot;127.0.0.1&quot;</span>);</span><br><span class="line">        factory.setPort(<span class="number">5672</span>); </span><br><span class="line">        factory.setVirtualHost(<span class="string">&quot;/vhost_name&quot;</span>);</span><br><span class="line">        factory.setUsername(<span class="string">&quot;guest&quot;</span>);</span><br><span class="line">        factory.setPassword(<span class="string">&quot;guest&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> factory.newConnection();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//生产者</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Send</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String Queue_name= <span class="string">&quot;test_simple_name&quot;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException </span>&#123;</span><br><span class="line">        Connection connection = ConnectionUtils.getConnection();</span><br><span class="line">        Channel channel = connection.createChannel();</span><br><span class="line">        channel.queueDeclare(Queue_name,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">null</span>);</span><br><span class="line">        </span><br><span class="line">        String msg = <span class="string">&quot;hello,sfjdkl&quot;</span>;</span><br><span class="line">        channel.basicPublish(<span class="string">&quot;&quot;</span>,Queue_name,<span class="keyword">null</span>,msg.getBytes());</span><br><span class="line"></span><br><span class="line">        channel.close();</span><br><span class="line">        connection.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//消费者</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Recieve</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String Queue_name= <span class="string">&quot;test_simple_name&quot;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException </span>&#123;</span><br><span class="line">        Connection connection = ConnectionUtils.getConnection();</span><br><span class="line">        Channel channel = connection.createChannel();</span><br><span class="line">        channel.queueDeclare(Queue_name,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">null</span>);</span><br><span class="line">        <span class="comment">//消费者，消费者中有监听，一旦有新的信息就就进行处理，重写了handlerDelivery方法</span></span><br><span class="line">        DefaultConsumer consumer = <span class="keyword">new</span> DefaultConsumer(channel) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                String msg = <span class="keyword">new</span> String(body, <span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">                System.out.println(<span class="string">&quot;new api recieve&quot;</span> + msg);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;;</span><br><span class="line">        channel.basicConsume(Queue_name,<span class="keyword">true</span>,consumer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>简单队列的不足：耦合性高，生产者与消费者一一对应，如果有多个消费者就不行了，或者队列名更改，也不行了</p>
<h3 id="二、work-queue-工作队列模式"><a href="#二、work-queue-工作队列模式" class="headerlink" title="二、work queue 工作队列模式"></a>二、work queue 工作队列模式</h3><p>出现的原因：简单队列是一一对应的，实际开发中生产者发送信息毫无费力，消费者需要跟业务相结合，消费者接收到消息之后就需要处理，可能需要花费时间，因此队列的消息容易积压，所以需要多个消费者</p>
<p><img src="C:\Users\vv\AppData\Roaming\Typora\typora-user-images\1594973561587.png" alt="1594973561587"></p>
<p>在简单队列基础上，直接再加一个消费者</p>
<p><strong>现象</strong></p>
<p>消费者1与消费者2处理的消息是一样的，不会因为消费者的处理时间快慢而不同，这种方式叫做轮询分发（round-robin）结果就是不管谁忙谁清闲，都不会多个一个消息或少给一个消息，依次轮转</p>
<p><strong>fair dispatch 为了使用公平分发</strong>，处理快的分发多一些，处理慢的分发少一些，</p>
<p>在生产者中设置每次发送一个，需要消费者应答后才继续发下一个；</p>
<p>在消费者中设置每次发送一个，并取消自动应答，添加手动应答</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//生产者</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Send</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String Queue_name= <span class="string">&quot;test_simple_name&quot;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException, InterruptedException </span>&#123;</span><br><span class="line">        Connection connection = ConnectionUtils.getConnection();</span><br><span class="line">        Channel channel = connection.createChannel();</span><br><span class="line"></span><br><span class="line">        channel.queueDeclare(Queue_name,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//每次只处理一个，限制发送给同一个消费者不得超过一条，收到应答后再发下一条</span></span><br><span class="line">        channel.basicQos(<span class="number">1</span>);</span><br><span class="line">        String msg = <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">50</span>; i++) &#123;</span><br><span class="line">            channel.basicPublish(<span class="string">&quot;&quot;</span>,Queue_name,<span class="keyword">null</span>,(msg+<span class="string">&quot;[&quot;</span>+i+<span class="string">&quot;]&quot;</span>).getBytes());</span><br><span class="line">            Thread.sleep(<span class="number">5</span>*i);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        channel.close();</span><br><span class="line">        connection.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//消费者，多个消费者，只需要把线程的休眠时间修改即可</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Recieve</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String Queue_name= <span class="string">&quot;test_simple_name&quot;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException </span>&#123;</span><br><span class="line">        Connection connection = ConnectionUtils.getConnection();</span><br><span class="line">        <span class="keyword">final</span> Channel channel = connection.createChannel();</span><br><span class="line">        channel.queueDeclare(Queue_name,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">//设置每次只接受一条信息，处理完了再接收下一条</span></span><br><span class="line">        channel.basicQos(<span class="number">1</span>);</span><br><span class="line">        </span><br><span class="line">        DefaultConsumer consumer = <span class="keyword">new</span> DefaultConsumer(channel) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                String msg = <span class="keyword">new</span> String(body, <span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">                System.out.println(<span class="string">&quot;new api recieve&quot;</span> + msg);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="comment">//添加手动应答</span></span><br><span class="line">                    channel.basicAck(envelope.getDeliveryTag(),<span class="keyword">false</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">//设置消费者对生产者是否自动应答，要设置为否</span></span><br><span class="line">        <span class="keyword">boolean</span> autoAck = <span class="keyword">false</span>;</span><br><span class="line">        channel.basicConsume(Queue_name,autoAck,consumer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="三、消息应答"><a href="#三、消息应答" class="headerlink" title="三、消息应答"></a>三、消息应答</h3><p>消费者的消息回执</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//取消自动确认，需要手动确认	</span></span><br><span class="line"><span class="keyword">boolean</span> autoAck = <span class="keyword">false</span>;</span><br><span class="line">channel.basicConsume(Queue_name,autoAck,consumer);</span><br><span class="line"></span><br><span class="line"><span class="comment">//自动确认</span></span><br><span class="line"><span class="keyword">boolean</span> autoAck = <span class="keyword">true</span>;</span><br><span class="line">channel.basicConsume(Queue_name,autoAck,consumer);</span><br></pre></td></tr></table></figure>

<ul>
<li>自动确认（默认）</li>
</ul>
<p>队列把消息给消费者，队列会马上把消息删除，然后消费者收到后自动返回一个ack；</p>
<p><strong>存在问题</strong>：①如果消费者没收到（比如消费者进程被关闭），那么这个消息就永远丢失了；</p>
<p>②消息在内存中，断电即丢失</p>
<p>问题①的解决：用手动确认</p>
<ul>
<li>手动确认</li>
</ul>
<p>队列把消息给消费者，消费者收到后处理完，再发出应答ack给队列，队列收到ack后，才会删除消息（在内存中）</p>
<p><strong>存在的问题</strong>：①消息在内存中，断电即丢失</p>
<p>解决方法：持久化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//设置持久化</span></span><br><span class="line"><span class="keyword">boolean</span> durable = <span class="keyword">true</span>;</span><br><span class="line">channel.queueDeclare(Queue_name,durable,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">null</span>);</span><br><span class="line"><span class="comment">//注意，如果一个队列实现声明了是非持久化的（durable = false;），那么后面直接把durable改成true也是不能把队列持久化的，需要重新声明一个队列，或者把原来的队列删除后，重新声明</span></span><br></pre></td></tr></table></figure>

<h3 id="四、订阅模式-publish-subscribe"><a href="#四、订阅模式-publish-subscribe" class="headerlink" title="四、订阅模式 publish subscribe"></a>四、订阅模式 publish subscribe</h3><p>比如公众号：</p>
<p><img src="C:\Users\vv\AppData\Roaming\Typora\typora-user-images\1595074479852.png" alt="1595074479852"></p>
<p><strong>特点</strong>：一个生产者，多个消费者； 每一个消费者都有自己的队列 ；这样的话每一条消息就能发给每个消费者</p>
<p>生产者没有直接把消息发送给队列，而是发到了交换机上，也称转发器</p>
<p>每个队列都要绑定到交换机上了生产中发送的消息，经过交换机，到达队列，就能<strong>实现一个消息被多个消费者收到</strong></p>
<p><strong>交换机的作用：</strong>一方面试接收生产者的消息，另一方面是向队列推送消息</p>
<p><strong>交换机的类型：</strong></p>
<p><strong>①fanout</strong>（不处理路由键，只要与交换机绑定的队列，都能收到消息）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//生产者，需要定义交换机</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Send</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String EXCHANGE_NAME= <span class="string">&quot;test_exchange_name&quot;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException, InterruptedException </span>&#123;</span><br><span class="line">        Connection connection = ConnectionUtils.getConnection();</span><br><span class="line">        Channel channel = connection.createChannel();</span><br><span class="line">		<span class="comment">//交换机类型为fanout，不处理路由键</span></span><br><span class="line">        channel.exchangeDeclare(EXCHANGE_NAME,<span class="string">&quot;fanout&quot;</span>);</span><br><span class="line"></span><br><span class="line">        channel.basicQos(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            String msg = <span class="string">&quot; hello&quot;</span>+i;</span><br><span class="line">            System.out.println(<span class="string">&quot;  success&quot;</span>+i );</span><br><span class="line">            <span class="comment">//这里第二个参数就是路由key，但是fanout类型是不用带的</span></span><br><span class="line">            channel.basicPublish(EXCHANGE_NAME,<span class="string">&quot;&quot;</span>,<span class="keyword">null</span>,msg.getBytes());</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        channel.close();</span><br><span class="line">        connection.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//消费者，需要定义自己的队列，并绑定交换机</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Recieve</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String Queue_name= <span class="string">&quot;test_publish_Sunscribe_name1&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String EXCHANGE_NAME= <span class="string">&quot;test_exchange_name&quot;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException </span>&#123;</span><br><span class="line">        Connection connection = ConnectionUtils.getConnection();</span><br><span class="line">        <span class="keyword">final</span> Channel channel = connection.createChannel();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        channel.queueDeclare(Queue_name,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">null</span>);</span><br><span class="line">        <span class="comment">//这个第三个参数就是交换机上路由的key，这里为空</span></span><br><span class="line">        channel.queueBind(Queue_name,EXCHANGE_NAME,<span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置每次只接受一条信息，处理完了再接收下一条</span></span><br><span class="line">        channel.basicQos(<span class="number">1</span>);</span><br><span class="line">        DefaultConsumer consumer = <span class="keyword">new</span> DefaultConsumer(channel) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                String msg = <span class="keyword">new</span> String(body, <span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">                System.out.println(<span class="string">&quot;new api recieve&quot;</span> + msg);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">                    channel.basicAck(envelope.getDeliveryTag(),<span class="keyword">false</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">//设置消费者对生产者是否自动应答</span></span><br><span class="line">        <span class="keyword">boolean</span> autoAck = <span class="keyword">false</span>;</span><br><span class="line">        channel.basicConsume(Queue_name,autoAck,consumer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>②direct</strong>（需要带路由的key，响应转到路由的key对应的队列中），也就是路由模式</p>
<h3 id="五、路由模式"><a href="#五、路由模式" class="headerlink" title="五、路由模式"></a>五、路由模式</h3><p>它的交换机类型为fanout或者direct</p>
<p><img src="C:\Users\vv\AppData\Roaming\Typora\typora-user-images\1595074463221.png" alt="1595074463221"></p>
<p>在上面的代码中，把空的路由key给补上即可</p>
<p>如果队列需要绑定多个路由key，则</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">channel.queueBind(Queue_name,EXCHANGE_NAME,<span class="string">&quot;routekey1&quot;</span>);</span><br><span class="line">channel.queueBind(Queue_name,EXCHANGE_NAME,<span class="string">&quot;routekey2&quot;</span>);</span><br><span class="line">channel.queueBind(Queue_name,EXCHANGE_NAME,<span class="string">&quot;routekey3&quot;</span>);</span><br></pre></td></tr></table></figure>

<h3 id="六、主题模式-topic"><a href="#六、主题模式-topic" class="headerlink" title="六、主题模式 topic"></a>六、主题模式 topic</h3><p><img src="C:\Users\vv\AppData\Roaming\Typora\typora-user-images\1595074434239.png" alt="1595074434239"></p>
<p><img src="C:\Users\vv\AppData\Roaming\Typora\typora-user-images\1595074448060.png" alt="1595074448060"></p>
<p>把消息分类，不同的消费者收到不同类型的消息</p>
<p>#：匹配一个或者多个</p>
<p>*：匹配一个</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//生产者，需要定义交换机</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Send</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String EXCHANGE_NAME= <span class="string">&quot;test_exchange_topic&quot;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException, InterruptedException </span>&#123;</span><br><span class="line">        Connection connection = ConnectionUtils.getConnection();</span><br><span class="line">        Channel channel = connection.createChannel();</span><br><span class="line">		<span class="comment">//交换机类型为topic，不处理路由键</span></span><br><span class="line">        channel.exchangeDeclare(EXCHANGE_NAME,<span class="string">&quot;topic&quot;</span>);</span><br><span class="line"></span><br><span class="line">        channel.basicQos(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            String msg = <span class="string">&quot; hello&quot;</span>+i;</span><br><span class="line">            System.out.println(<span class="string">&quot;  success&quot;</span>+i );</span><br><span class="line">            <span class="comment">//这里第二个参数就是路由key,topic类型的交换机下，需要输入不同的key</span></span><br><span class="line">            channel.basicPublish(EXCHANGE_NAME,<span class="string">&quot;goods.add&quot;</span>,<span class="keyword">null</span>,msg.getBytes());</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        channel.close();</span><br><span class="line">        connection.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//消费者，需要定义自己的队列，并绑定交换机</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Recieve</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String Queue_name= <span class="string">&quot;test_topic_name1&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String EXCHANGE_NAME= <span class="string">&quot;test_exchange_topic&quot;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException </span>&#123;</span><br><span class="line">        Connection connection = ConnectionUtils.getConnection();</span><br><span class="line">        <span class="keyword">final</span> Channel channel = connection.createChannel();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        channel.queueDeclare(Queue_name,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">null</span>);</span><br><span class="line">        <span class="comment">//这个第三个参数就是交换机上路由的key，可以接受大goods类型所有的消息</span></span><br><span class="line">        channel.queueBind(Queue_name,EXCHANGE_NAME,<span class="string">&quot;goods.#&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置每次只接受一条信息，处理完了再接收下一条</span></span><br><span class="line">        channel.basicQos(<span class="number">1</span>);</span><br><span class="line">        DefaultConsumer consumer = <span class="keyword">new</span> DefaultConsumer(channel) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                String msg = <span class="keyword">new</span> String(body, <span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">                System.out.println(<span class="string">&quot;new api recieve&quot;</span> + msg);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">                    channel.basicAck(envelope.getDeliveryTag(),<span class="keyword">false</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">//设置消费者对生产者是否自动应答</span></span><br><span class="line">        <span class="keyword">boolean</span> autoAck = <span class="keyword">false</span>;</span><br><span class="line">        channel.basicConsume(Queue_name,autoAck,consumer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="七、消息确认机制"><a href="#七、消息确认机制" class="headerlink" title="七、消息确认机制"></a>七、消息确认机制</h3><p>通过持久化数据，可以解决rabbitmq服务器异常导致的消息丢失问题</p>
<p>怎样判断消息是否传到消费者：两种方式，①AMQP实现了事务机制， ②cofirm模式</p>
<p><strong>事务机制：</strong>txSelect   txCommit   txRollback</p>
<p>txSelect：将当前channel设置为transaction模式</p>
<p>txCommit：用于事务提交</p>
<p>txRollback：事务回滚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//生产者</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Send</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String Queue_name= <span class="string">&quot;test_transaction_name&quot;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException </span>&#123;</span><br><span class="line">        Connection connection = ConnectionUtils.getConnection();</span><br><span class="line">        Channel channel = connection.createChannel();</span><br><span class="line">        channel.queueDeclare(Queue_name,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">null</span>);</span><br><span class="line">        String msg = <span class="string">&quot;hello,transaction&quot;</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">           		 channel.txSelect();</span><br><span class="line">       			 channel.basicPublish(<span class="string">&quot;&quot;</span>,Queue_name,<span class="keyword">null</span>,msg.getBytes());</span><br><span class="line">            <span class="comment">//...//很多条，再提交</span></span><br><span class="line">                 channel.txCommit();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            		channel.txRollback();</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">     </span><br><span class="line">        channel.close();</span><br><span class="line">        connection.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>缺点</strong>：每一次发送和提交都要请求，消耗了资源，降低了吞吐量</p>
<p>解决方法：</p>
<p><strong>生产者端confirm模式</strong></p>
<ul>
<li>该模式是异步</li>
<li>如果生产者端出现异常，会发出一条Nack消息</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">channel.confirmSelect();</span><br></pre></td></tr></table></figure>

<p><strong>分类</strong></p>
<ol>
<li>普通模式  都是串行的</li>
</ol>
<p>每次发出一条，waitForConfirms();    发一条消息，收一条确认</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//生产者</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Send</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String Queue_name= <span class="string">&quot;test_confirm1_name&quot;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException </span>&#123;</span><br><span class="line">        Connection connection = ConnectionUtils.getConnection();</span><br><span class="line">        Channel channel = connection.createChannel();</span><br><span class="line">        channel.queueDeclare(Queue_name,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">null</span>);</span><br><span class="line">        String msg = <span class="string">&quot;hello,confirms&quot;</span>;</span><br><span class="line">        <span class="comment">//设置为confirm模式，注意需要新的队列，一旦队列是某种模式，就不能修改</span></span><br><span class="line">        channel.confirmSelect();</span><br><span class="line">        channel.basicPublish(<span class="string">&quot;&quot;</span>,Queue_name,<span class="keyword">null</span>,msg.getBytes());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(!channel.waitForConfirms())&#123;</span><br><span class="line">            <span class="comment">//发送失败</span></span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">//发送成功</span></span><br><span class="line">        &#125;</span><br><span class="line">     </span><br><span class="line">        channel.close();</span><br><span class="line">        connection.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>批量模式   都是串行的</li>
</ol>
<p>每次发一批，waitForConfirms();   与普通模式类似，就是发送多条，然后一次收到确认</p>
<ol start="3">
<li>异步confirm模式</li>
</ol>
<p>提供一个回调方法，收到消息后会执行回调方法</p>
<p>//维护一个同步队列，用于存储消息的一个编号，每发送一条，就把该消息编号存入</p>
<p>//本质是在信道加一个监听器，监听器中有一个监听确认对象，有两个回调方法，分别处理确认信号和Nack信号</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Send</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String Queue_NAME= <span class="string">&quot;test_confirm2_name&quot;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException, InterruptedException </span>&#123;</span><br><span class="line">        Connection connection = ConnectionUtils.getConnection();</span><br><span class="line">        Channel channel = connection.createChannel();</span><br><span class="line"></span><br><span class="line">        channel.queueDeclare(Queue_NAME,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">null</span>);</span><br><span class="line">        <span class="comment">//设置为confirm模式</span></span><br><span class="line">        channel.confirmSelect();</span><br><span class="line">		</span><br><span class="line">        <span class="keyword">final</span> SortedSet&lt;Long&gt; confirmSet = Collections.synchronizedSortedSet(<span class="keyword">new</span> TreeSet&lt;Long&gt;());</span><br><span class="line">        <span class="comment">//在信道加一个监听器</span></span><br><span class="line">        channel.addConfirmListener(<span class="keyword">new</span> ConfirmListener() &#123;</span><br><span class="line">			<span class="comment">//处理是否收到确认消息</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleAck</span><span class="params">(<span class="keyword">long</span> deliveryTag, <span class="keyword">boolean</span> multiple)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                <span class="keyword">if</span>(multiple)&#123; <span class="comment">//多条，就清除，再往下一条</span></span><br><span class="line">                    confirmSet.headSet(deliveryTag+<span class="number">1</span>).clear();</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123; <span class="comment">//单条，就把当前的消息编号清除掉</span></span><br><span class="line">                    confirmSet.remove(deliveryTag);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleNack</span><span class="params">(<span class="keyword">long</span> deliveryTag, <span class="keyword">boolean</span> multiple)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                <span class="keyword">if</span>(multiple)&#123;</span><br><span class="line">                    confirmSet.headSet(deliveryTag+<span class="number">1</span>).clear();</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    confirmSet.remove(deliveryTag);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">            String msg = <span class="string">&quot; hello confirms&quot;</span>+i;</span><br><span class="line">            <span class="comment">//生成当前消息编号</span></span><br><span class="line">            <span class="keyword">long</span> seqNo = channel.getNextPublishSeqNo();</span><br><span class="line">            channel.basicPublish(<span class="string">&quot;&quot;</span>,Queue_NAME,<span class="keyword">null</span>,msg.getBytes());</span><br><span class="line">            <span class="comment">//放入集合中</span></span><br><span class="line">            confirmSet.add(seqNo);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        channel.close();</span><br><span class="line">        connection.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="应用场景："><a href="#应用场景：" class="headerlink" title="应用场景："></a>应用场景：</h3><p> ①后台的商品增加与删除：</p>

  </div>
</article>



      </div>
      
       <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/home/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a target="_blank" rel="noopener" href="http://github.com/tzvetkov75">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="toc-number">1.</span> <span class="toc-text">消息队列</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80-%E3%80%81%E7%AE%80%E5%8D%95%E9%98%9F%E5%88%97%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.1.</span> <span class="toc-text">一 、简单队列模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81work-queue-%E5%B7%A5%E4%BD%9C%E9%98%9F%E5%88%97%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.2.</span> <span class="toc-text">二、work queue 工作队列模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E6%B6%88%E6%81%AF%E5%BA%94%E7%AD%94"><span class="toc-number">1.3.</span> <span class="toc-text">三、消息应答</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E8%AE%A2%E9%98%85%E6%A8%A1%E5%BC%8F-publish-subscribe"><span class="toc-number">1.4.</span> <span class="toc-text">四、订阅模式 publish subscribe</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E8%B7%AF%E7%94%B1%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.5.</span> <span class="toc-text">五、路由模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%AD%E3%80%81%E4%B8%BB%E9%A2%98%E6%A8%A1%E5%BC%8F-topic"><span class="toc-number">1.6.</span> <span class="toc-text">六、主题模式 topic</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%83%E3%80%81%E6%B6%88%E6%81%AF%E7%A1%AE%E8%AE%A4%E6%9C%BA%E5%88%B6"><span class="toc-number">1.7.</span> <span class="toc-text">七、消息确认机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF%EF%BC%9A"><span class="toc-number">1.8.</span> <span class="toc-text">应用场景：</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://shakespeawang.github.io/2020/10/28/rabbitmq/"><i class="fa fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://shakespeawang.github.io/2020/10/28/rabbitmq/&text="><i class="fa fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://shakespeawang.github.io/2020/10/28/rabbitmq/&title="><i class="fa fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://shakespeawang.github.io/2020/10/28/rabbitmq/&is_video=false&description="><i class="fa fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=&body=Check out this article: https://shakespeawang.github.io/2020/10/28/rabbitmq/"><i class="fa fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://shakespeawang.github.io/2020/10/28/rabbitmq/&title="><i class="fa fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://shakespeawang.github.io/2020/10/28/rabbitmq/&title="><i class="fa fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://shakespeawang.github.io/2020/10/28/rabbitmq/&title="><i class="fa fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://shakespeawang.github.io/2020/10/28/rabbitmq/&title="><i class="fa fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://shakespeawang.github.io/2020/10/28/rabbitmq/&name=&description="><i class="fa fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
      <ul>
        <li id="toc"><a class="icon" href="#" onclick='$("#toc-footer").toggle();return false;'><i class="fa fa-list fa-lg" aria-hidden="true"></i> TOC</a></li>
        <li id="share"><a class="icon" href="#" onclick='$("#share-footer").toggle();return false;'><i class="fa fa-share-alt fa-lg" aria-hidden="true"></i> Share</a></li>
        <li id="top" style="display:none"><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></li>
        <li id="menu"><a class="icon" href="#" onclick='$("#nav-footer").toggle();return false;'><i class="fa fa-bars fa-lg" aria-hidden="true"></i> Menu</a></li>
      </ul>
    </div>

  </div>
</div>

      
      <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2020 Shakespeawang
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/home/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a target="_blank" rel="noopener" href="http://github.com/tzvetkov75">Projects</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

      
<script src="/lib/justified-gallery/jquery.justifiedGallery.min.js"></script>


<script src="/js/main.js"></script>

<!-- Google Analytics -->

<!-- Disqus Comments -->


    </div>
</body>
</html>
